az group create --location "eastus" --name "%env.KUBERNETES_RESOURCE_GROUP%" --subscription "%AZURE_SUBSCRIPTION%"

echo "Creating vnet"
az network vnet create --name "%env.KUBERNETES_RESOURCE_GROUP%-vnet" --resource-group "%env.KUBERNETES_RESOURCE_GROUP%" --location "eastus" --address-prefixes "10.0.0.0/18"

echo "Creating K8s cluster"
az aks create --resource-group "%env.KUBERNETES_RESOURCE_GROUP%" --name "%KUBERNETES_SERVER_NAME%" --kubernetes-version "%env.K8S_VERSION%" --max-pods 50 --network-plugin "azure" --node-count 3 --node-vm-size "Standard_DS3_v2" --nodepool-name "agentpool" --location "eastus" --client-secret "%env.CLIENT_SECRET%" --service-principal "%env.CLIENT_ID%" --dns-service-ip "10.0.0.10"  --docker-bridge-address "172.17.0.1/16" --service-cidr "10.0.0.0/21" --admin-username "crdsadmin" --ssh-key-value "%env.SSH_PUBLICKEY%" 

echo "Creating IP addresses"
az network public-ip create --name "crossroads-int" --resource-group "MC_%env.KUBERNETES_RESOURCE_GROUP%_%KUBERNETES_SERVER_NAME%_eastus" --allocation-method "Static" --location "eastus" --sku "Standard"
az network public-ip create --name "api-int" --resource-group "MC_%env.KUBERNETES_RESOURCE_GROUP%_%KUBERNETES_SERVER_NAME%_eastus" --allocation-method "Static" --location "eastus" --sku "Standard"

bash /home/teamcity/update-az-ip-environment-var.sh "%env.KUBERNETES_RESOURCE_GROUP%_%KUBERNETES_SERVER_NAME%" "api-int" "env.API_IP" "%env.TEAMCITY_SERVICE_ACCOUNT%" "%env.TEAMCITY_SERVICE_PASSWORD%"
bash /home/teamcity/update-az-ip-environment-var.sh "%env.KUBERNETES_RESOURCE_GROUP%_%KUBERNETES_SERVER_NAME%" "crossroads-int" "env.CROSSROADS_NET_IP" "%env.TEAMCITY_SERVICE_ACCOUNT%" "%env.TEAMCITY_SERVICE_PASSWORD%"

echo "API IP = %env.API_IP%"
echo "Crossroads IP = %env.CROSSROADS_NET_IP%"